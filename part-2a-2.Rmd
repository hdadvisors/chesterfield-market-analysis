# Rental spatial analysis

This section presents an analysis of the countyâ€™s existing rental supply, focusing on the amount and location of rental housing units. 

```{r setup}

library(sf)
library(sp)
library(janitor)
library(tidyverse)
library(leaflet)
library(ggplot2)
library(plotly)
library(simplevis)

```

## Recent multifamily developments

The last five years have shown fluctuating multifamily development completions based on CoStar's proprietary commercial real estate database. From zero completed units in 2018 to a five year high of 1,569 units in 2020, development has been sporadic but is expected to grow significantly in the coming years. Most recent development has consisted of low-rise buildings, offering luxury amenities such as clubhouses, pools, and fitness centers.

As of June 2022, there were 34 existing market-rate multifamily developments that were either built in the last five years, under construction, or proposed. Development in the past five years has generally been spread across the county, but only one development was completed in the Dale District.

Thirty-two percent of recent and future development has been or will be constructed in the Midlothian District. In 2023 and 2024, 3,757 new rental homes are expected to be completed --- slightly more than the number of homes completed between 2020 and 2022. The overwhelming majority of these developments will be completed in the Midlothian District.

This shift in intense development can be attributed to increasing home demand in this affluent and amenity rich portion of the county. Greenfield development in the western part of the county also contributes to its attractiveness to multifamily and mixed-use developers.

```{r recent}

#CoStar filter - Chesterfield County, VA; Property type: Multi-Family; Construction status: Existing, Proposed, Under Construction; Year Built Min: 2017

#Included Lat/Long in export

#Might want to consider adding in additional BHC developments into this list of properties. Winchester Forest (160 units), Colbrook (152 units), and Horner Run (49 units). Swift Creek Station should be condensed into a single entry? Different buildings of different stories but same development. I emailed Jessica for information about this development. Would be nice to have that information included. Should probably email Lee about those BHC projects and get addresses and expected year built.

recent <- read_csv("data/costar_market_recent.csv") |> 
  clean_names()

#Bring in magisterial districts from Chesterfield County Geospace.

districts_geojson <- "https://services3.arcgis.com/TsynfzBSE6sXfoLq/ArcGIS/rest/services/Administrative/FeatureServer/9/query?outFields=*&where=1%3D1&f=geojson"

districts <- read_sf(districts_geojson)

plot(districts$geometry)

recent <- as.data.frame(recent) |> 
  st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE)


#Spatial join of recent developments to magisterial districts.
newbuilds_by_district <- st_join(recent, left = FALSE, districts["MagDistName"])

#Leaflet map of new builds. Would like to mask to just Chesterfield County.
leaf_sf_col(newbuilds_by_district,
            col_var = MagDistName)

#Summarize number of units by magisterial districts.
recentunits <- newbuilds_by_district |> 
  st_drop_geometry() |> 
  select("District" = MagDistName, number_of_units)|> 
  mutate_at(vars("number_of_units"),
                 ~replace_na(.,0)) |> 
  group_by(District) |> 
  summarise(Units = sum(number_of_units)) |> 
  mutate(District = str_to_sentence(District))

#Create bar chart of number of units by magisterial districts.
recent <- gg_bar_col(recentunits,
               x_var = District,
               y_var = Units,
               col_var = District)

plotly::ggplotly(recent) |> 
  plotly_camera()

#Summarize number of units by year to show future development timeline.
status_units <- newbuilds_by_district |> 
  st_drop_geometry() |> 
  select("Status" = building_status, "Units" = number_of_units, "Year" = year_built, "District" = MagDistName)|> 
  mutate_at(vars("Units"),
                 ~replace_na(.,0)) |> 
  filter(Year != 2027)

status_timeline <- gg_bar_col(status_units,
                          x_var = Year,
                          y_var = Units,
                          col_var = District)

plotly::ggplotly(status_timeline) |> 
  plotly_camera()

#It might be helpful to size dots by number of units. Colors need to be changed to be more visible. 
districts |> plot_mapbox() |> 
  add_sf(
    data = newbuilds_by_district,
    y = ~latitude,
    x = ~longitude,
    color = ~ MagDistName
  )

#Determining average number of units by property. Remove NA values.
average_units <- mean(newbuilds_by_district$number_of_units, na.rm = TRUE)


```

- MAP OF RECENT DEVELOPMENTS
- BAR CHART OF UNITS BY MAGISTERIAL DISTRICT

## Market affordable rental

Market affordable rental housing is spread throughout each district of Chesterfield County. However, the majority of market affordable rentals lie along the city-county border. This is a typical trend in most metropolitan areas, wherein early suburban development in the mid- to late 20th century led to small garden apartment development.

The Bermuda District, which includes the entirety of the Route One corridor, contains the largest number of market affordable rental properties, specifically manufactured home communities (8 from the city border down to Route 10). 


```{r noah}

#Costar filter - Chesterfield County, VA, Property type: Multi-family; Construction status: Existing; Rent Type: Market; Class: B or C; CoStar Building Rating: three or fewer stars

#Include manufactured home communities identified by 2016 MHCCV study

#I still have some concerns about the filters chosen because they include some newer builds like Colony Village II. I think there should be an additional filter for year built. I would want to exclude anything built after 1999. I would also remove 3201 Lady Marian Ln which is an over 4,000 SF single-family home. These changes would need to be reflected in previous Part 1 section on NOAH. 

noah <- read_csv("data/chesterfield_noah_coded.csv") |> 
  clean_names()

noah <- as.data.frame(noah) |> 
  st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE)

#Spatial join NOAH properties to magisterial districts.
noah_by_district <- st_join(noah, left = FALSE, districts["MagDistName"])

noah_by_district <- noah_by_district |> 
  filter(is.na(yearbuilt)|yearbuilt<2000) |> 
  filter(address != "3201 Lady Marian Ln") |> 
  mutate(type = case_when(
    style == "Garden" ~ "Multifamily",
    style == "Low-Rise" ~ "Multifamily",
    TRUE ~ style
  ))

leaf_sf_col(noah_by_district,
            col_var = MagDistName)

#Summarize number of NOAH units by magisterial districts. Add in a note about NA values
noahunits <- noah_by_district |> 
  st_drop_geometry() |> 
  select("District" = MagDistName, units)|> 
  mutate_at(vars("units"),
                 ~replace_na(.,0)) |> 
  group_by(District) |> 
  summarise(Units = sum(units)) |> 
  mutate(District = str_to_sentence(District))

#Create bar chart for total NOAH units by magisterial districts.
noah_count <- gg_bar_col(noahunits,
               x_var = District,
               y_var = Units,
               col_var = District)

plotly::ggplotly(noah_count) |> 
  plotly_camera()

#Create bar chart showing type by magisterial district.

noah_sum_district <- noah_by_district |> 
  group_by(MagDistName, type) |> 
  summarise(Units = sum(units))

noah_t_district <- gg_bar_col(noah_sum_district,
                              x_var = MagDistName,
                              y_var = Units,
                              stack = TRUE,
                              col_var = type)

plotly::ggplotly(noah_t_district) |> 
  plotly_camera()

#Create map showing NOAH by type.

leaf_sf_col(noah_by_district,
            col_var = type)



```

- MAP OF MARKET AFFORDABLE (TWO COLORS FOR MULTIFAMILY AND MHCs)
- STACKED BAR CHART OF UNITS BY MAGISTERIAL DISTRICT (TWO COLORS FOR MULTIFAMILY AND MHCs)

## Affordable rental

Spatial analysis of affordable housing projects. Generally describe:
- Project types,
- Developer types (nonprofit or for profit)
- Unit mix
- Subsidy types (focus on LIHTC)
- Status of subsidy (when expire?)
```

```{r affordable}

affordable <- read_csv("data/nhpd_chesterfield.csv") |> 
  clean_names() |> 
  filter(subsidy_status != "Inactive") |> 
  select(property_name, owner_name, owner_type, subsidy_name, subsidy_subname, assisted_units, known_total_units, lat, long, street_address)

affordable <- as.data.frame(affordable) |> 
  st_as_sf(coords = c("long", "lat"), crs=4326, remove=FALSE)


#Spatial join NHPD properties to magisterial districts.
affordable_by_district <- st_join(affordable, left = FALSE, districts["MagDistName"])


leaf_sf_col(affordable_by_district,
            col_var = MagDistName)

#Summarize number of NHPD units by magisterial districts. Add in a note about NA values
affunits <- affordable_by_district |> 
  st_drop_geometry() |> 
  select("District" = MagDistName, "Units" = assisted_units)|> 
  group_by(District) |> 
  summarise(sum(Units)) |> 
  mutate(District = str_to_sentence(District))

#Create bar chart for NHPD units by magisterial districts.
affcount <- gg_bar_col(affunits,
               x_var = District,
               y_var = Units,
               col_var = District)

plotly::ggplotly(affcount) |> 
  plotly_camera()


```

- MAP OF AFFORDABLE PROPERTIES (COLOR BY SUBSIDY TYPE)
- STACKED BAR CHART OF UNITS BY MAGISTERIAL DISTRICT (COLOR BY SUBSIDY TYPE)

### Price comparison

- Compare affordable (rent-restricted) rents to market-rate (non-affordable) rents
- For market-rate, include ALL other CoStar properties, not just NOAH
- Show at county level and magisterial district
- Since CoStar is showing average rent by property, don't want to average the averages
- Could do colored box plot where color is affordable vs non-affordable, each column is magisterial district

https://statisticsnz.github.io/simplevis/reference/gg_boxplot_col.html