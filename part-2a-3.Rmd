# Market comparison {#part-2a-3}

This section will make comparisons between recent multifamily developments and existing rental supply in the county. For the purposes of this section, "recent" developers are those built in the past five years, are under construction, or are proposed. This analysis does not include single-family rentals, nor manufactured home communities.

```{r setup}

library(tidyverse)
library(zoo)
library(janitor)
library(simplevis)
library(ggplot2)
library(plotly)
library(leaflet)
library(htmlwidgets)
library(sf)
library(mapview)
library(crsuggest)
library(tigris)
library(mapboxapi)
library(scales)
library(nngeo)
options(tigris_use_cache = TRUE)

```

## Price

For much of the past five years, the difference in rental prices between recent and existing rental properties has remained at nearly \$400. But when the pandemic hit in the second quarter of 2020, the gap began to narrow.

Both recent and existing properties experienced a jump in average rent in the second quarter of 2020. While recent properties experienced a 1% increase in average rents, existing property average rents increased by 4% --- closing the gap to \$352. This difference in percent of change over time has continued to Q2 2022.

From Q2 2020 to Q2 2022, average rent for recent properties has changed 3% --- from \$1,696 to \$1,743. Existing property average rent growth was three times (9%) that of recent properties --- going from \$1,344 to \$1,460. From Q2 2017 to Q2 2022, the difference in average rent between recent and existing properties has gone from \$410 to \$285.

While average rents for recent properties has remained steady, existing property rents have risen dramatically. The COVID-19 pandemic has significantly impacted demand among the existing stock of rental housing in the county --- leading to complementary increases in rental prices.

```{r price}

# CoStar Recent Filter: Multi-family; Chesterfield County, VA; Construction Status: Existing, Under Construction, Proposed; Style: Townhome, Garden, Low-Rise, Mid-Rise, Hi-Rise; Min Year Built: 2017

# Load in costar_rent_recent.csv; Average rents for all units and by bedrooms

recent_price <- read_csv("data/costar_rent_recent.csv") |> 
  mutate(market = "recent") |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1))

# CoStar Past Filter: Multi-family; Chesterfield County, VA; Construction Status: Existing, Under Construction, Proposed; Style: Townhome, Garden, Low-Rise, Mid-Rise, Hi-Rise; Max Year Built: 2016

# Manually remove: 7626 Sandler Dr; 3201 Lady Marian Ln; 21203 Orange Hill Ave --- before conducting analytics

# Load in costar_rent_past.csv; Average rents for all units and by bedrooms

past_price <- read_csv("data/costar_rent_past.csv") |> 
  mutate(market = "existing") |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1))

# Both files cover 2017 Q1 -> 2022 Q2

# Filter "studio" out for both

price_comp <- rbind(recent_price, past_price)

```

```{r price-all, fig.cap="Average rent of existing and recent rental units"}

avg_rent_all <- price_comp |> 
  filter(bedrooms == "All") |> 
  mutate(rent_adj = parse_number(rent_adj),
         rent = parse_number(rent))

total_avg_rent <- gg_line_col(
  avg_rent_all,
  x_var = period,
  y_var = rent_adj,
  col_var = market,
  alpha_point = 0,
  size_line = 0.75,
  x_title = "",
  y_title = "",
  col_title = "",
  y_labels = scales::label_dollar(),
  x_labels = scales::label_date(format = "%Y"),
  title = "Average rent of existing and recent rental units") +
  ggplot2::scale_x_date(limits = as.Date(c(NA, Sys.Date()))) +
  ggplot2::theme(
  legend.position = "top",
  legend.direction = "horizontal",
  legend.justification = "center")

total_avg_rent

```

*Source: CoStar Group, Inc.*

Price difference between recent and existing properties by number of bedrooms follows similar trends. But average rents for recent three-bedroom rentals experienced a significant increase in the middle of 2021 --- going from \$2,152 in Q2 2021 to \$2,337 in Q4 2021. In 2022, these rents began to decline somewhat, but still remained above \$2,000.

```{r price-br, fig.cap="Average rent of existing and recent rental units by bedroom"}

avg_rent_br <- price_comp |> 
  filter(bedrooms != "Studio") |> 
  filter(bedrooms != "All") |> 
  mutate(rent_adj = parse_number(rent_adj),
         rent = parse_number(rent))

br_avg_rent <- gg_line_col_facet(
  avg_rent_br,
  x_var = period,
  y_var = rent_adj,
  col_var = market,
  facet_var = bedrooms,
  alpha_point = 0,
  size_line = 0.75,
  x_title = "",
  y_title = "",
  col_title = "",
  y_labels = scales::label_dollar(),
  x_labels = scales::label_date(format = "%Y"),
  title = "Average rent of existing and recent rental units by bedroom") +
  ggplot2::scale_x_date(limits = as.Date(c(NA, Sys.Date()))) +
  ggplot2::theme(
  legend.position = "top",
  legend.direction = "horizontal",
  legend.justification = "center")

br_avg_rent

```

*Source: CoStar Group, Inc.*

In all cases, the percent change in average rents for existing rental properties was three times that of recent properties no matter the bedroom count. One- and two-bedroom existing rentals had a near 20 percent increase in average rents from 2017 to 2022, while three-bedroom average rents increased by 16 percent. Average rents for recent rental properties only had an increase of 5 to 7 percent. The difference in rents between recent and existing properties as of Q2 2022 ranges from \$204 for one-bedrooms to \$552 for three-bedrooms.

## Unit mix

### Building style

Consumer preferences can change over time and those preference changes can impact market demand and prices. Multifamily building styles built in the late 20th century were largely in the garden-style apartments. The garden-style emphasizes lower densities and clustered development. Residents typically have ground floor access with no neighbors above.

Existing rental properties are majority garden-style (85 percent). But the composition of recent multifamily development is much more diverse. Although though garden-style apartments are still being produced, the majority (82 percent) of newer multifamily properties are low- or mid-rise buildings.

The shift towards these types of developments provides developers with greater economies of scale. More density makes it more financially possible to finance and develop properties. Without the density that comes through low- and mid-rise buildings, developers have to rely heavily on higher rents or substantial subsidies to make development possible.

```{r unit-mix, fig.cap="Share of units by type for existing and recent properties"}

# Need list of existing, proposed, or under construction properties with... 

# CoStar Filters: Multi-family; Chesterfield County, VA; Construction Status: Existing, Under Construction, Proposed; Style: Townhome, Garden, Low-Rise, Mid-Rise, Hi-Rise

# Updated 7420 Ashlake Pky with Name; Updated Maisonettes Apartments with 1966 Year Built; Updated Kenswick Apartments with 1984 Year Built; Updated 3101 Danzler Cir with Name

# - Number of units
# - Style (mid-rise, garden, etc)
# - Number of 1, 2, 3, and 4 bedroom units
# - Avg sqft for 1, 2, and 3 bedroom units

unit_mix <- read_csv("data/costar_unit_mix.csv") |> 
  clean_names()

# Remove single-family homes incorrectly categorized as Low-Rise; select variables needed

unit_mix_clean <- unit_mix  |> 
  filter(property_address != "3201 Lady Marian Ln") |> 
  filter(property_address != "7626 Sandler Dr") |> 
  filter(property_address != "21203 Orange Hill Ave") |>
  filter(property_address != "12020 Winfree St") |> 
  select("address" = property_address, "name" = property_name, "status" = building_status, year_built, style, "units" = number_of_units, avg_unit_sf, rent_type, "units0" = number_of_studios_units, "units1" = number_of_1_bedrooms_units, "units2" = number_of_2_bedrooms_units, "units3" = number_of_3_bedrooms_units, "units4" = number_of_4_bedrooms_units, "sf0" = studio_avg_sf, "sf1" = one_bedroom_avg_sf, "sf2" = two_bedroom_avg_sf, "sf3" = three_bedroom_avg_sf, "sf4" = four_bedroom_avg_sf, latitude, longitude)

unit_mix_clean <- unit_mix_clean |> 
  mutate(market = case_when(
    year_built <= 2016 ~ "Existing",
    year_built >= 2017 ~ "Recent",
    name == "Ashlake Crossing" ~ "Recent"))

# By style

style_mix <- unit_mix_clean |> 
  group_by(market, style) |> 
  summarise(units = sum(units)) |> 
  mutate(pct = units/sum(units))

# Percent of total properties by style.

style_mix_bar <- gg_bar_col_facet(
  style_mix,
  x_var = style,
  y_var = pct,
  col_var = market,
  facet_var = market,
  x_labels = function(x) x,
  y_labels = scales::label_percent(),
  y_title = "",
  x_title = "",
  col_legend_none = TRUE,
  title = "Share of units by type for existing and recent properties"
)

style_mix_bar

```

*Source: CoStar Group, Inc.*

### Bedrooms

Existing rental development mainly consists of two-bedroom rental homes (55 percent) and one-bedrooms (27 percent). More recent developments have shifted towards to one-bedroom rentals (53 percent). The percent of larger rentals - two- and three-bedrooms - being produced has dropped to 36 percent and 9 percent, respectively.

One-bedroom rentals meets a growing demand among young professionals and aging seniors in the county, but the lack of larger rental homes leaves growing families out of the multifamily rental market. Single-family homes are increasingly meeting the demand for larger families in need of rentals. Although this often is preferred by families who want greater privacy and more in-home separation, the single-family rental market can impact opportunities for potential homebuyers.

```{r br-mix, fig.cap="Share of units by bedrooms for existing and recent properties"}

# By bedroom

br_mix_long <- unit_mix_clean |> 
  select(address, market, units0, units1, units2, units3, latitude, longitude) |> 
  pivot_longer(
    c(units0, units1, units2, units3),
    names_to = "bedrooms",
    values_to = "units"
  )

br_mix <- br_mix_long |> 
  group_by(market, bedrooms) |> 
  na.omit() |> 
  summarise(units = sum(units)) |> 
  mutate(pct = units/sum(units)) |> 
  mutate(bedrooms = case_when(
    bedrooms == "units0" ~ "Studio",
    bedrooms == "units1" ~ "1 bed",
    bedrooms == "units2" ~ "2 bed",
    bedrooms == "units3" ~ "3 bed",
  ))

# Percent of total units by bedroom by market

br_mix_bar <- gg_bar_col_facet(
  br_mix,
  x_var = bedrooms,
  y_var = pct,
  col_var = market,
  facet_var = market,
  x_labels = function(x) x,
  y_labels = scales::label_percent(),
  y_title = "",
  x_title = "",
  col_legend_none = TRUE,
  title = "Share of units by bedrooms for existing and recent properties"
)

br_mix_bar

```

*Source: CoStar Group, Inc.*

### Size

On average, the significant number of new one-bedroom apartments are close in size to the county's existing supply of one-bedroom units---around 750 square feet. New two- and three-bedroom apartments are noticeably larger than older units, however. Recently-built three-bedroom rentals are now approaching 1,500 square feet.

```{r sf-mix, fig.cap="Share of units by size for existing and recent properties"}

# By square footage

sf_mix <- unit_mix_clean |> 
  select(address, market, sf0, sf1, sf2, sf3) |> 
  pivot_longer(
    c(sf0, sf1, sf2, sf3),
    names_to = "bedroom",
    values_to = "sf"
  ) |> 
  na.omit() |> 
  mutate(bedroom = case_when(
    bedroom == "sf0" ~ "Studio",
    bedroom == "sf1" ~ "1 bed",
    bedroom == "sf2" ~ "2 bed",
    bedroom == "sf3" ~ "3 bed"
  )) |> 
  filter(bedroom != "Studio")

# Box plot of average sf of bedrooms by properties

sf_mix_box <- gg_boxplot_col_facet(
  sf_mix,
  y_var = sf,
  x_var = market,
  col_var = market,
  facet_var = bedroom,
  x_title = "",
  y_title = "Average square footage",
  col_title = "",
  col_legend_none = TRUE,
  title = "Share of units by size for existing and recent properties")

sf_mix_box

```

*Source: CoStar Group, Inc.*

## Amenities

The types of amenities and features on a rental property have also changed of time as consumer preferences and expectations have shifted. While there are many possible examples of "amenities", this analysis compares the prevalence of four common features across rental properties in the county.

These amenities, which are included in property-level data from CoStar, include:

-   Clubhouse,
-   On-site property manager,
-   Pool, and
-   Fitness center.

On average, newer apartment communities are much more likely to have at least two of these amenities compared to older properties. In fact, about 90 percent of all new developments have two or more amenities, versus just 71 percent of existing properties.

```{r amenities, fig.cap="Percent of existing and recent properties by number of amenities"}

# Need list of existing, proposed, or under construction properties with "Amenities" field
# Create new columns for each amenity that will show T/F
# If amenity is listed in original CoStar field, its respective column will be TRUE
# Use stringr::str_detect()
# Example: mutate(pool = str_detect(amenities, "Pool"))

# May need to up the number of amenities a bit. It's not telling a great story based on the data. Mainly because there are several NULL values for recent developments because amenities are not listed yet.

amenities <- read_csv("data/costar_unit_mix.csv") |> 
  clean_names()

amenities_clean <- amenities |> 
  filter(property_address != "3201 Lady Marian Ln") |> 
  filter(property_address != "7626 Sandler Dr") |> 
  filter(property_address != "21203 Orange Hill Ave") |>
  filter(property_address != "12020 Winfree St") |> 
  select("address" = property_address, "name" = property_name, "status" = building_status, style, "units" = number_of_units, avg_unit_sf, year_built, rent_type, amenities, latitude, longitude) |> 
  mutate(market = case_when(
    year_built <= 2016 ~ "Existing",
    year_built >= 2017 ~ "Recent",
    name == "Ashlake Crossing" ~ "Recent"))


amenities_clean <- amenities_clean |> 
  mutate(pool = str_detect(amenities, "Pool"),
         clubhouse = str_detect(amenities, "Clubhouse"),
         fitness = str_detect(amenities, "Fitness Center"),
         propmanager = str_detect(amenities, "Property Manager on Site"))

amenity_count <- amenities_clean |> 
  select(address, market, pool, clubhouse, fitness, propmanager) |> 
  na.omit() |> 
  rowwise() |> 
  mutate(count = as.character(sum(c_across(pool:propmanager) == "TRUE")),
         count = str_replace(count, "0", "None"))

amenity_summary <- amenity_count |> 
  group_by(market, count) |> 
  summarise(n = n()) |> 
  mutate(pct = n / sum(n)) |>  
  mutate(count = fct_relevel(count, "None"))

amenity_bar <- gg_bar_col_facet(
  amenity_summary,
  x_var = count,
  y_var = pct,
  col_var = market,
  facet_var = market,
  x_labels = function(x) x,
  y_labels = scales::label_percent(),
  y_title = "",
  x_title = "Number of amenities",
  col_legend_none = TRUE,
  title = "Percent of existing and recent properties by number of amenities"
)

amenity_bar

```

*Source: CoStar Group, Inc.*

## Location

New rental development has occurred all across Chesterfield County in recent years. However, as the map below shows, much of that activity has been concentrated along Route 288 from Midlothian Turnpike south to Hull Street. This development is notable for being located in areas where multifamily housing is not already prevalent.

On the other side of the county, there are five new developments along Route 1, plus several more just to the west following Route 10. These recent properties, unlike those along Route 288, do not make up the majority of multifamily housing in the area.

```{r location, fig.cap="Map of recent and existing multifamily rental properties"}

comp_map2 <- unit_mix_clean |> 
  mutate(market = case_when(
    year_built <= 2016 ~ "Existing",
    year_built >= 2017 ~ "Recent",
    name == "Ashlake Crossing" ~ "Recent")) |> 
  select(address, name, status, year_built, market, style, units, rent_type, latitude, longitude) |> 
  sf::st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE)

# pal <- colorFactor(c("red", "blue"), domain = c("Recent", "Existing"))

# comp_location_map <- leaf_sf_col(comp_map2,
#                                  col_var = market,
#                                  label_var = name)
# 
# saveWidget(comp_location_map, "maps/comp_location_map.html")

knitr::include_url("maps/comp_location_map.html", height = "500px")

```

### Proximity to public transportation

Within the county, there are only 20 out of 115 multifamily properties located within a half mile walking distance of a public transit stop. The majority of these properties are existing properties, while only six are recent developments (built in 2017 or later).

These transit stops are mainly located at the city-county border along Midlothian Turnpike or along Route One, where the Greater Richmond Transit Company (GRTC) began local bus service from Falling Creek to John Tyler Community College in March 2020. One recent development (Commonwealth Apartments built in 2022) has taken advantage of an Express Service Park-N-Ride located at Commonwealth Centre Parkway. This transit service provides a direct route from Commonwealth Centre Parkway to Downtown Richmond --- whether for work or leisure. 



```{r transit-setup, eval=FALSE}

# Load CoStar properties and change 'Market/Affordable' to just 'Affordable'

comp <- unit_mix_clean |> 
  mutate(market = case_when(
    year_built <= 2016 ~ "Existing",
    year_built >= 2017 ~ "Recent",
    name == "Ashlake Crossing" ~ "Recent")) |> 
  select(address, name, status, year_built, market, style, units, rent_type, latitude, longitude) |> 
  sf::st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE)|> 
  mutate(property_id = 1:nrow(unit_mix_clean))

va_crs <- suggest_top_crs(comp, units = "m",
                          inherit_gcs = FALSE)

comp_prj <- st_transform(comp, va_crs)

tracts_map <- tracts("VA", "Chesterfield", year = 2021) |>
  st_transform(va_crs)

comp_tracts <- st_filter(tracts_map, comp_prj)

stops <- st_read("data/grtc/Stops_May2022.shp") |> 
  st_transform(va_crs)

network_buffer <- mb_isochrone(comp_prj,
                                  profile = "walking",
                                  distance = 805)


nearest_stops <- st_nn(comp_prj, stops, k = 20)
```

```{r transit-analysis, eval=FALSE}

comp_stop_walking <- imap(nearest_stops, ~{
  
  property <- comp_prj[.y,]
  
  nearby_stops <- stops[.x, ]

  mb_matrix(origins = property,
            destinations = nearby_stops,
            profile = "walking",
            output = "distance")}) |> 
  reduce(rbind) |> 
  apply(1, min) |> 
  magrittr::divide_by(1609.34)

trans_map <- comp |>
   mutate(
     walk_to_transit = comp_stop_walking,
     transit_nearby = case_when(
       walk_to_transit <= 0.5 ~ "1/2 mile or less",
       walk_to_transit > 0.5 ~ "More than 1/2 mile"),
     name = fct_reorder(name, walk_to_transit)
   )

write_rds(trans_map, "data/trans_map.rds")

# mean(trans_map$walk_to_transit)
# 3.207206

```

The overwhelming majority of both recent and existing multifamily properties in the county are located more than a half mile walking distance of a transit stop. On average, the walking distance for all multifamily properties in the county to a transit stop is 3.2 miles --- which would take most people nearly an hour to walk. There is little difference between recent and existing properties in terms of distance to transit, but undoubtedly any new multifamily development on the Route 1 corridor will continue to benefit from public transit access.

```{r transit-chart, fig.cap="Percent of units in Chesterfield County near transit by market"}

trans_map <- read_rds("data/trans_map.rds")

trans_sum <- trans_map |> 
  st_drop_geometry() |>
  group_by(market, transit_nearby) |> 
  summarise(units = sum(units)) |> 
  drop_na() |> 
  mutate(pct = units/sum(units))

gg_bar_col_facet(trans_sum,
                 x_var = transit_nearby,
                 y_var = pct,
                 col_var = transit_nearby,
                 facet_var = market,
                 x_title = "",
                 y_title = "",
                 x_labels = element_blank(),
                 col_labels = function(x) x,
                 y_labels = label_percent(),
                 y_breaks_n = 5,
                 title = "Percent of units in Chesterfield County near transit by market"
                 )

```

### Proximity to schools

Across the entire county, there are 64 schools within the Chesterfield County Public Schools (CCPS) system serving more than 63,000 students. As the county continues to attract more and more families, the desire to be in close proximity to schools at all levels will continue to grow.

In the county, there are 39 elementary schools, 12 middle schools, and 11 high schools. 

All 115 multimfamily properties are within a 30 minute drive to a CCPS school. More specifically, all properties are less than an eight minute drive of a CCPS school. The average drive time for all multifamily properties to a CCPS school is only about 5 minutes, and there is hardly any difference between recent and existing properties in the average drive time --- 4.7 and 4.9 minutes, respectively.

```{r school-map, eval=FALSE}

schools <- st_read("https://services3.arcgis.com/TsynfzBSE6sXfoLq/ArcGIS/rest/services/Administrative/FeatureServer/15/query?outFields=*&where=1%3D1&f=geojson") |> 
  st_transform(va_crs)

nearest_schools <- st_nn(comp_prj, schools, k = 20)

```

```{r schools-setup, eval=FALSE}

# I think I would want to understand the number of schools within a distance of certain properties and what schools those are. 

school_driving <- imap(nearest_schools, ~{
  
  property <- comp_prj[.y,]

  nearby_schools <- schools[.x, ]

  mb_matrix(origins = property,
            destinations = nearby_schools,
            profile = "driving",
            output = "duration")
}) |> 
  reduce(rbind) |> 
  apply(1, min)

schools_map <- comp |>
  st_drop_geometry() |> 
  mutate(
    minutes_to_school = school_driving,
    school_nearby = ifelse(minutes_to_school <= 30, 1, 0),
    ) |> 
  drop_na(market) |> 
  mutate(address = fct_reorder(address, minutes_to_school))

write_rds(schools_map, "data/schools_map.rds")

# mean(schools_map$minutes_to_school)
# 4.839377

schools_map_grp <- schools_map |> 
  group_by(market) |> 
  summarise(avg = mean(minutes_to_school))


```

```{r schools-chart, fig.cap="Driving time to schools in Chesterfield County by market"}

schools_map <- read_rds("data/schools_map.rds")

gg_bar_col(schools_map,
           x_var = address,
           y_var = minutes_to_school,
           col_var = market,
           x_labels = element_blank(),
           x_title = "Properties",
           title = "Driving time to schools in Chesterfield County by market")

```

### Proximity to grocery stores

Convenient access to affordable and healthy foods helps support family and individual health. When households have access to food options like fresh fruits and vegetables, they can potentially lower their risk for chronic disease. Close proximity to full service groceries that accept [Supplemental Nutrition Assistance Program (SNAP)](https://www.cbpp.org/research/food-assistance/the-supplemental-nutrition-assistance-program-snap) helps keep low-income families and individuals out of hunger, but also helps save time and money in commuting.

While many convenience stores accept SNAP, the food options are not always the healthiest. Highly processed foods and other snacks do not provide the nutritional value of many food products found at full service grocery retailers.

```{r grocery-setup, eval=FALSE}

# Grocery stores:
# We'll use SNAP retailers from the USDA as a proxy here
# This is not perfect so some filtering may be necessary
# as it picks up on convenience stores as well

snap <- read_csv("https://opendata.arcgis.com/datasets/e9cc76a48ccb45628181ece7b2deb56d_0.csv") %>%
  filter(State == "VA") %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326) %>%
  st_transform(va_crs)

snap_fullservice <- snap |> 
  filter(str_detect(Store_Name, regex("food lion|publix|Costco|Kroger|aldi|lidl|whole foods|walmart|save-a-lot|sam's club|farm fresh", ignore_case = T)))

snap_convenience <- snap |> 
  filter(!str_detect(Store_Name, regex("food lion|publix|Costco|Kroger|aldi|lidl|whole foods|walmart|save-a-lot|sam's club|farm fresh", ignore_case = T)))
  
# Full service grocery filter

nearest_snap <- st_nn(comp_prj, snap_fullservice, k = 20)

snap <- imap(nearest_snap, ~{

  property <- comp_prj[.y,]

  nearby_snap <- snap_fullservice[.x, ]

  mb_matrix(origins = property,
            destinations = nearby_snap,
            profile = "walking",
            output = "distance")
}) %>%
  reduce(rbind) %>%
  apply(1, min) %>%
  magrittr::divide_by(1609.34)

snap_map <- comp |>
  mutate(
    miles_to_snap = snap,
    snap_nearby = ifelse(miles_to_snap <= 0.5, 1, 0))

# Convenience store filter

nearest_snapconvenience <- st_nn(comp_prj, snap_convenience, k = 20)

convenience <- imap(nearest_snapconvenience, ~{

  property <- comp_prj[.y,]

  nearby_snapconvenience <- snap_convenience[.x, ]

  mb_matrix(origins = property,
            destinations = nearby_snapconvenience,
            profile = "walking",
            output = "distance")
}) %>%
  reduce(rbind) %>%
  apply(1, min) %>%
  magrittr::divide_by(1609.34)

grocery_map <- snap_map |>
  mutate(
    miles_to_convenience = convenience,
    convenience_nearby = ifelse(miles_to_convenience <= 0.5, 1, 0))

write_rds(grocery_map, "data/grocery_map.rds")

# mean(grocery_map$miles_to_snap)
# 1.358127

# mean(grocery_map$miles_to_convenience)
# 0.7906736

# grocery_map_grp <- grocery_map |> 
#   group_by(market) |> 
#   summarise(avg_gro = mean(miles_to_snap),
#             avg_con = mean(miles_to_convenience))

```

```{r grocery-chart, fig.cap="Mean distance from apartments in Chesterfield County to food stores by market"}

grocery_map <- read_rds("data/grocery_map.rds")

grocery_sum <- grocery_map |> 
  st_drop_geometry() |> 
  drop_na(market) |> 
  group_by(market) |> 
  summarise(mean_snap = mean(miles_to_snap),
            mean_convenience = mean(miles_to_convenience)) |> 
  pivot_longer(2:3,
               names_to = 'store_type',
               values_to = 'miles') |> 
  mutate(store_type = case_when(
    store_type == "mean_snap" ~ "SNAP retailer",
    store_type == "mean_convenience" ~ "Convenience store"
  ))

gg_bar_col_facet(grocery_sum,
                 x_var = store_type,
                 y_var = miles,
                 col_var = store_type,
                 facet_var = market,
                 x_title = "",
                 y_title = "Miles",
                 x_labels = element_blank(),
                 col_labels = function(x) x,
                 title = "Mean distance from apartments in Chesterfield County to food stores by type"
                 )

```
The prevalence of convenience stores across the county accounts for their closer proximity to both recent and existing multifamily properties. But the average distance to a full service grocery is over a mile for existing properties and has only increased to just over 1.5 miles for recent multifamily properties.

The increasing distance of recent multifamily to full service groceries increases the likelihood of food deserts --- low-income, low-access areas. Food access should continue to considered as new multifamily development grows across the county.

### Proximity to healthcare

Healthcare access is important to growing communities as households age and new family members are added. Healthy communities are maintained when residents can not only afford healthcare, but also reasonably reach healthcare. 
[General acute care hospitals](https://www.vhi.org/Hospital-Guide/general-hospitals.asp) provide 24-hour patient care and conduct many of the major procedures that help 
treat chronic illnesses, as well as save people in an emergency situation. Urgent care facilities, on the other hand, provide easy walk-in access for non-emergency healthcare. Often less expensive than a hospital visit, urgent care offers patients help when they are unsure of their illness.

Being within a short driving distance to a hospital or urgent care can be lifesaving, but it can also mean more frequent care to support a longer life. In the county, the average drive time to a hospital from a multifamily property is about 12 minutes, while it is 9 minutes to an urgent care.

More recent development has been closer to hospitals (10 minutes) than existing development (12 minutes). But recent development has been getting further away from urgent cares (10 minutes) compared to 9 minutes for existing development. This has implications for low- and moderate-income households who can more likely afford urgent care compared to hospital visits.

```{r medical-setup, eval=FALSE}

# Hospital / urgent care
# I'm not filtering by type but you might consider doing so
# There are some other datasets in HIFLD on care centers that may 
# be relevant as well.

hospitals <- st_read("https://services1.arcgis.com/Hp6G80Pky0om7QvQ/arcgis/rest/services/Hospitals_1/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") %>%
  filter(STATE == "VA") %>%
  st_transform(va_crs) |> 
  filter(STATUS == "OPEN") |> 
  filter(TYPE == "GENERAL ACUTE CARE")

urgentcare <- st_read("https://services1.arcgis.com/Hp6G80Pky0om7QvQ/arcgis/rest/services/Urgent_Care_Facilities/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") %>%
  filter(STATE == "VA") %>%
  st_transform(va_crs)

nearest_hospitals <- st_nn(comp_prj, hospitals, k = 20)

hospital_driving <- imap(nearest_hospitals, ~{
  # Get the specific property (the list index)
  property <- comp_prj[.y,]
  # Get the nearby hospitals (the indices in the list element)
  nearby_hospitals <- hospitals[.x, ]
  # Calculate the matrix (drive-times here instead)
  # Minutes are returned by default
  mb_matrix(origins = property,
            destinations = nearby_hospitals,
            profile = "driving",
            output = "duration")
}) %>%
  reduce(rbind) %>%
  apply(1, min)

hospital_map <- comp |>
  mutate(
    minutes_to_hospital = hospital_driving,
    hospital_nearby = ifelse(minutes_to_hospital <= 15, 1, 0))

nearest_urgent <- st_nn(comp_prj, urgentcare, k = 20)

urgent_driving <- imap(nearest_urgent, ~{
  # Get the specific property (the list index)
  property <- comp_prj[.y,]
  # Get the nearby hospitals (the indices in the list element)
  nearby_urgent <- urgentcare[.x, ]
  # Calculate the matrix (drive-times here instead)
  # Minutes are returned by default
  mb_matrix(origins = property,
            destinations = nearby_urgent,
            profile = "driving",
            output = "duration")
}) %>%
  reduce(rbind) %>%
  apply(1, min)

health_map <- hospital_map |>
  mutate(
    minutes_to_urgent = urgent_driving,
    urgent_nearby = ifelse(minutes_to_urgent <= 15, 1, 0))

write_rds(health_map, "data/health_map.rds")

mean(health_map$minutes_to_hospital)
11.71194

mean(health_map$minutes_to_urgent)
9.181826



```

```{r r1-health-chart, fig.cap="Mean driving time from apartments in Chesterfield County to healthcare facility by market"}

health_map <- read_rds("data/health_map.rds")

health_sum <- health_map |> 
  st_drop_geometry() |> 
  drop_na(market) |> 
  group_by(market) |> 
  summarise(mean_hospital = mean(minutes_to_hospital),
            mean_urgent = mean(minutes_to_urgent)) |> 
  pivot_longer(2:3,
               names_to = 'health_type',
               values_to = 'minutes') |> 
  mutate(health_type = case_when(
    health_type == "mean_hospital" ~ "Hospital",
    health_type == "mean_urgent" ~ "Urgent care"
  ))

gg_bar_col_facet(health_sum,
                 x_var = health_type,
                 y_var = minutes,
                 col_var = health_type,
                 facet_var = market,
                 x_title = "",
                 y_title = "Minutes",
                 col_title = "Facility",
                 x_labels = element_blank(),
                 col_labels = function(x) x,
                 title = "Mean driving time from apartments in Chesterfield County to healthcare facility by market"
                 )

```

### Proximity to job centers

With transportation being many households second highest expense after housing, a daily commute to work can quickly eat into a households budget the longer it is. Job centers are located all across the region, but areas with the highest paying jobs are located in Downtown Richmond and business parks like West Creek in Henrico County or Meadowville in Chesterfield County. 
With many multifamily properties located along major corridors and near the city-county border, proximity to job centers is not a problem for those commuters with personal vehicles. A commute to the city is made easier with the Powhite Parkway and I-95 access. But an assortment of jobs are necessary for a diverse and thriving economy. For any income household shorter commutes help save money, which can be used on housing and life's other necessities. However, fewer job opportunities for low-income households in close proximity to home mean longer commutes and more money spent on transportation --- especially in localities where public transportation isn't available. 

In the county, the share of jobs paying more than \$39,996 within a 15 minute drive of multifamily properties is near 50 percent for both recent and existing properties --- 47 and 49 percent, respectively. Recent multifamily development is increasingly located in areas wherein there are lower paying jobs (below \$39,996). This means greater job opportunities for low- and moderate-income households within a short distance. But mixed-use developments, or live-work-play communities, are increasingly desired by diverse households. 

Meeting the needs of houesholds all within a walking distance is a growing trend and is being seen across the region. The Midlothian Special Area Plan helps support development like this which helps households of all kind find employment opportunities with having to depend on a car.
    
```{r jobs, eval=FALSE}

va_wac <- grab_lodes(
  state = "va",
  year = 2019,
  lodes_type = "wac",
  use_cache = TRUE
)

# Jobs with earnings more than $3333/month.

va_jobs <- va_wac %>%
  select(w_geocode, total_jobs = C000, hi_paying_jobs = CE03, mid_paying_jobs = CE02, lo_paying_jobs = CE01, hs_jobs = CD02, ba_jobs = CD04)

options(tigris_use_cache = TRUE)

va_blocks <- blocks("VA", year = 2019)

va_jobs_sf <- va_blocks %>%
  select(w_geocode = GEOID10) %>%
  inner_join(va_jobs, by = "w_geocode")

# Removed time because depart at not allowed anymore?

comp_isos <- mb_isochrone(
  location = comp,
  profile = "driving",
  time = 15,
  id_column = "property_id"
)

reachable_jobs <- st_join(
  st_transform(comp_isos, 6594),
  st_centroid(st_transform(va_jobs_sf, 6594)),
  left = FALSE
) %>%
  st_drop_geometry() %>%
  group_by(id) %>%
  summarize(hi_jobs = sum(hi_paying_jobs, na.rm = TRUE),
            mid_jobs = sum(mid_paying_jobs, na.rm = TRUE),
            lo_jobs = sum(lo_paying_jobs, na.rm = TRUE),
            total_jobs = sum(total_jobs, na.rm = TRUE),
            hs_jobs = sum(hs_jobs, na.rm = TRUE),
            ba_jobs = sum(ba_jobs, na.rm = TRUE))

jobs <- comp |> 
  mutate(id = property_id)|> 
  left_join(reachable_jobs, by = "id") |> 
  select(name, address, market,
         total_jobs, hi_jobs, mid_jobs, lo_jobs, ba_jobs, hs_jobs) |> 
  transform(hi_percent = hi_jobs/total_jobs) |> 
  transform(lo_percent = lo_jobs/total_jobs) |> 
  drop_na(market)

write_rds(jobs, "data/jobs.rds")

# mean(jobs$hi_percent)
# .45
# 
# mean(jobs$lo_percent)
# 
# .23

```

```{r jobs-chart, fig.cap="Percent of jobs by wage within 15 minute drive by market in Chesterfield County"}

jobs <- read_rds("data/jobs.rds")

jobs_sum <- jobs |>
  st_drop_geometry() |> 
  group_by(market) |> 
  summarise(lo_jobs = sum(lo_jobs)/sum(total_jobs),
            mid_jobs = sum(mid_jobs)/sum(total_jobs),
            hi_jobs = sum(hi_jobs)/sum(total_jobs)) |> 
  pivot_longer(2:4,
               names_to = "wage",
               values_to = "pct") |> 
  mutate(wage = case_when(
    wage == "lo_jobs" ~ "$15,000 or less",
    wage == "mid_jobs" ~ "$15,000 to $39,996",
    wage == "hi_jobs" ~ "More than $39,996"
  ))

gg_bar_col_facet(jobs_sum,
                 x_var = wage,
                 y_var = pct,
                 col_var = wage,
                 facet_var = market,
                 x_title = "",
                 y_title = "Percent",
                 col_title = "Annualized wage",
                 x_labels = element_blank(),
                 y_labels = label_percent(),
                 col_labels = function(x) x,
                 title = "Percent of jobs by wage within 15 minute drive of apartments by market in Chesterfield County"
                 )

```
