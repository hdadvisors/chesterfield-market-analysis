# Household cost burden {#part-1b-3}

This section provides an analysis of cost burden within Chesterfield County disaggregated by tenure, household type, and race/ethnicity.

## Background

[reserved]

```{r global, include=FALSE}

library(glue)
library(httr)
library(jsonlite)
library(tidyverse)
library(readxl)
library(ggplot2)
library(plotly)

```

## Tenure

With the share of renters increasing in Chesterfield County, the share of renter households experiencing cost burden has been in decline in recent years---dropping from 45 percent in 2013 to 42 percent in 2018. But the actual number of cost-burdened renters has been on the rise---from 10,495 at the start of the decade to 12,795 cost-burdened renters in 2018.

For homeowners, cost burden has decreased across the board. There were 21,305 cost-burdened homeowners in 2010, but that number decreased significantly to 16,945 in 2018---a 20 percent decrease. The total share of cost-burdened homeowners has shrunk, from nearly one in four (24 percent) in 2010 to 18 percent in 2018. 

```{r tenure}

my_token <- Sys.getenv("HUD_KEY")

hud_chas_request <- GET("https://www.huduser.gov/hudapi/public/chas?type=3&year=2012-2016&stateId=51&entityId=59",
                        add_headers(Authorization = glue("Bearer {my_token}")))

# hud_chas_request$status_code

get_hud_chas <- function(
  type, 
  year = NULL, 
  state_id = NULL, 
  entity_id = NULL, 
  token = NULL
) {
  
  # Check to see if a token exists
  if (is.null(token)) {
    if (Sys.getenv("HUD_KEY") != "") {
      token <- Sys.getenv("HUD_KEY")
    }
  }
  
  # Specify the base URL
  base_url <- "https://www.huduser.gov/hudapi/public/chas"
  
  # Make the query
  hud_query <- httr::GET(
    base_url,
    httr::add_headers(Authorization = glue::glue("Bearer {token}")),
    query = list(
      type = type,
      year = year,
      stateId = state_id,
      entityId = entity_id)
  )
  
  # Return the HTTP error message if query failed
  if (hud_query$status_code != "200") {
    msg <- httr::content(hud_query, as = "text")
    return(msg)
  }
  
  # Return the content as text
  hud_content <- httr::content(hud_query, as = "text")
  
  # Convert the data to a long-form tibble
  hud_tibble <- hud_content %>%
    jsonlite::fromJSON() %>%
    dplyr::as_tibble() %>%
    tidyr::pivot_longer(cols = !dplyr::all_of(c("geoname", "sumlevel", "year")),
                        names_to = "indicator",
                        values_to = "value")
  
  return(hud_tibble)
  
}

years <- c("2014-2018", "2013-2017","2012-2016","2011-2015", "2010-2014", 
           "2009-2013", "2008-2012","2007-2011", "2006-2010")

chesterfield <- map_dfr(years, function(yr){
  chesterfield_chas <- get_hud_chas(
    type = 3, 
    year = yr, 
    state_id = 51, 
    entity_id = 041
    )
})

labels <- read_excel("data/CHAS_HUD_Dictionary.xlsx")

chesterfield_chas <- chesterfield %>%
  right_join(labels, by = 'indicator') %>% 
  mutate(value = as.numeric(value))

chesterfield_cb <- chesterfield_chas %>%
  filter(type == "Cost burden") %>%
  mutate(year = as.numeric(str_sub(year,6,9))) %>%
  select(year, cb = income, tenure, value) %>%
  filter(tenure != "All") %>% 
  group_by(year, tenure) %>%
  mutate(pct = value/sum(value)) %>% 
  ungroup() %>% 
  filter(cb != "Cost burden not available")

cb_tenure <- ggplot(chesterfield_cb, aes(x=year, y=pct, group=tenure)) +
  geom_line(aes(color=tenure)) +
  facet_grid(cols = vars(cb)) +
  labs(x=NULL, y=NULL) +
  scale_y_continuous(labels=scales::percent_format()) +
  scale_x_continuous(breaks = 2010:2020) +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5))

print(cb_tenure)


```

## Household type

```{r hhtype}

hhtype_chas <- read_csv("data/Table7_2012to2018.csv") %>%
  filter(fips == 51041) %>%
  filter(Line_Type == "Detail") %>%
  select(year = Year, estimate = Estimate, moe = MOE, tenure = Tenure, income = `Household income`, hhtype = `Household type`, costburden = `Cost burden`)

hhtype_clean <- hhtype_chas %>%
  mutate(income = case_when(
    income == "household income is less than or equal to 30% of HAMFI" ~ "30% AMI or less",
    income == "household income is greater than 30% but less than or equal to 50% of HAMFI" ~ "31% to 50% AMI",
    income == "household income is greater than 50% but less than or equal to 80% of HAMFI" ~ "51% to 80% AMI",
    income == "household income is greater than 80% but less than or equal to 100% of HAMFI" ~ "81% to 100% AMI",
    income == "household income is greater than 100% of HAMFI" ~ "Greater than 100% AMI"
  )) %>%
  mutate(hhtype = case_when(
    hhtype == "household type is elderly family (2 persons, with either or both age 62 or over)" ~ "Elderly family",
    hhtype == "household type is elderly non-family" ~ "Elderly non-family",
    hhtype == "household type is large family (5 or more persons)" ~ "Large family",
    hhtype == "household type is small family (2 persons, neither person 62 years or over, or 3 or 4 persons)" ~ "Small family",
    hhtype == "other household type (non-elderly non-family)" ~ "Other family type"
  )) %>%
  mutate(costburden = case_when(
    costburden == "housing cost burden is less than or equal to 30%" ~ "Not cost-burdened",
    costburden == "housing cost burden is greater than 30% but less than or equal to 50%" ~ "Cost-burdened",
    costburden == "housing cost burden is greater than 50%" ~ "Severely cost-burdened",
    costburden == "housing cost burden not computed (household has no/negative income)" ~ "No or negative income"
  ))

```

[reserved]

## Race/ethnicity

In the county, there are major disparities in cost burden between racial and ethnic 
groups. In 2018, the share of cost-burdened white households was ten percentage points 
lower than the share of Black, Asian, and Hispanic households.

In spite of these disparities, the share of cost burdened households of color has been 
in a steady decline. Most significantly, Hispanic households have experienced the greatest 
decrease in cost burden --- from nearly half of all Hispanic households in 2010 to only 
one in three (34 percent) in 2018. 

These decreases in cost burden among households of color may be in large part to the 
relative affordability and attractiveness of Chesterfield County to growing families. 

```{r race}

race_chas <- read_csv("data/Table9_2012to2018.csv") %>%
  filter(fips == 51041) %>%
  filter(Line_Type == "Detail") %>%
  select(year = Year, estimate = Estimate, moe = MOE, tenure = Tenure, race = `Race/ethnicity`, costburden = `Cost burden`)

race_clean <- race_chas %>%
  mutate(across(.fns = ~str_remove_all(.x, "alone, non-Hispanic"))) %>% # I haven't figured out how to retain this for White
  mutate(race = case_when(
    race == "other (including multiple races, non-Hispanic)" ~ "Another race incuding multiracial",
    TRUE ~ race
  )) %>%
    mutate(costburden = case_when(
    costburden == "less than or equal to 30%" ~ "Not cost-burdened",
    costburden == "greater than 30% but less than or equal to 50%" ~ "Cost-burdened",
    costburden == "greater than 50%" ~ "Severely cost-burdened",
    costburden == "not computed (household has no/negative income)" ~ "No or negative income"
  ))
  
  
```
## Takeaways

[reserved]